rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Users & Problems (Unchanged) ---
    match /users/{userId} {
      allow read, update: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
    }
    match /problems/{problemId} {
      allow read: if request.auth != null;
    }

    // --- ROOMS (THIS IS THE COMPLETE FIX) ---
    match /rooms/{roomId} {
    
      // 1. Allows TabCreateRoom.js to create the doc
      allow create: if request.auth != null; 
    
      // 2. FIXES THE REJOIN LOOP
      // Allows useRoom.js to listen with onSnapshot
      allow read: if request.auth != null;
    
      // 3. Allows RoomPage.js to add/remove participants
      allow update: if request.auth != null; 
    
      // 4. FIXES THE DELETE ERROR
      // Allows the host (and only the host) to delete the room
      allow delete: if request.auth.uid == resource.data.hostId;
    }
  }
}